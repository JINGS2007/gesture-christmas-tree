<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>3D Magic Christmas Tree</title>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; }
        #main-title {
            position: absolute; top: 15px; width: 100%; text-align: center;
            font-family: 'Great Vibes', cursive; font-size: clamp(2.5rem, 7vw, 4.5rem);
            background: linear-gradient(to bottom, #ffd700, #fff);
            -webkit-background-clip: text; background-clip: text;
            -webkit-text-fill-color: transparent; z-index: 50; pointer-events: none;
            text-shadow: 0 0 25px rgba(255,215,0,0.4);
        }
        #start-screen {
            position: absolute; inset: 0; background: radial-gradient(circle at center, #1a1a2e 0%, #000 100%);
            z-index: 200; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #fff;
        }
        #btn-start {
            padding: 20px 60px; font-size: 24px; background: linear-gradient(90deg, #ffd700, #ffaa00);
            border: none; border-radius: 50px; color: #000; font-weight: bold; cursor: pointer;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.5); transition: 0.3s;
        }
        #photo-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
            max-width: 80vw; padding: 15px; background: #fff; border-radius: 10px;
            box-shadow: 0 0 50px rgba(0,0,0,0.5); z-index: 150; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #photo-modal.active { transform: translate(-50%, -50%) scale(1); }
        #photo-modal img { width: 100%; border-radius: 5px; }
        #status-bar { position: absolute; bottom: 20px; width: 100%; text-align: center; color: #ffd700; z-index: 100; font-size: 14px; }
        #ui-panel {
            position: fixed; top: 80px; right: 20px; width: 260px; background: rgba(0,0,0,0.8);
            padding: 20px; border-radius: 15px; color: #fff; z-index: 100; transform: translateX(300px); transition: 0.5s;
        }
        #ui-panel.show { transform: translateX(0); }
        #toggle-ui { position: fixed; top: 20px; right: 20px; z-index: 101; font-size: 24px; cursor: pointer; background:none; border:none; }
        #input_video { position: fixed; bottom: 10px; left: 10px; width: 140px; height: 100px; border: 2px solid #ffd700; border-radius: 10px; object-fit: cover; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="main-title">Merry Christmas</div>
    <div id="status-bar">ç­‰å¾…å”¤é†’é­”æ³•...</div>

    <div id="start-screen">
        <h1 style="font-family: 'Great Vibes'; font-size: 5rem; margin-bottom: 0;">Winter Dream</h1>
        <p style="color: #ffd700; text-align: center;">ğŸ–ï¸ å¼ å¼€/æ¡æ‹³ï¼šçˆ†ç‚¸è®°å¿†<br>ğŸ‘Œ æåˆï¼šå¼¹å‡ºè®°å¿†ç…§ç‰‡<br>â†•ï¸ ä¸Šä¸‹ç§»åŠ¨ï¼šæ§åˆ¶é­”æ³•æ ‘é«˜åº¦</p>
        <button id="btn-start">å¼€å¯ 3D é­”æ³•</button>
    </div>

    <div id="photo-modal"><img id="modal-img" src=""><p style="text-align:center;color:#333;font-family:'Great Vibes'">Sweet Memory</p></div>
    
    <button id="toggle-ui">âš™ï¸</button>
    <div id="ui-panel">
        <h3 style="color:#ffd700">ğŸ„ é­”æ³•å·¥åŠ</h3>
        <button style="width:100%;padding:10px;background:#ffd700;border:none;border-radius:5px;font-weight:bold" onclick="document.getElementById('img-input').click()">ğŸ“· å¯¼å…¥è®°å¿†ç…§ç‰‡ (å¤šé€‰)</button>
        <input type="file" id="img-input" multiple accept="image/*" style="display:none">
        <p style="font-size:12px;color:#888;margin-top:10px">ä¸Šä¼ ç…§ç‰‡åï¼Œç…§ç‰‡ä¼šæŒ‚è½½åœ¨æ ‘ä¸Šã€‚å•æ‰‹æåˆæŒ‡å°–å¯éšæœºå‘¼å”¤ä¸€å¼ è®°å¿†ã€‚</p>
    </div>

    <video id="input_video" style="display:none"></video>

    <script>
        const state = { explosion: 0, targetExplosion: 0, treeHeight: 70, photoActive: false };
        let scene, camera, renderer, treeGroup, star, loadedImages = [], decorMeshes = [];

        document.getElementById('btn-start').onclick = () => {
            document.getElementById('start-screen').style.display = 'none';
            initThree();
            startTracking();
        };

        document.getElementById('toggle-ui').onclick = () => document.getElementById('ui-panel').classList.toggle('show');

        function initThree() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 40, 110);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const pointLight = new THREE.PointLight(0xffd700, 1.5, 200);
            pointLight.position.set(0, 80, 50);
            scene.add(pointLight);

            treeGroup = new THREE.Group();
            scene.add(treeGroup);

            create3DTree();
            create3DStar();
            animate();
        }

        // åˆ›å»ºå¤šå…ƒç´ åœ£è¯æ ‘
        function create3DTree() {
            decorMeshes.forEach(m => treeGroup.remove(m));
            decorMeshes = [];

            const h = state.treeHeight;
            const items = 500; // æ ¸å¿ƒè£…é¥°ç‰©æ•°é‡

            // 1. åœ£è¯è£…é¥°çƒã€çˆ±å¿ƒã€æ­£æ–¹ä½“
            const geometries = [
                new THREE.SphereGeometry(1.2, 16, 16),      // åœ†çƒ
                new THREE.BoxGeometry(1.5, 1.5, 1.5),       // æ­£æ–¹ä½“
                new THREE.TorusGeometry(0.8, 0.4, 8, 16)    // ç”œç”œåœˆ/ç¯
            ];

            const colors = [0xff0000, 0x00ff00, 0x00aaff, 0xffd700, 0xff69b4, 0xffffff];

            for (let i = 0; i < items; i++) {
                const y = (i / items) * h;
                const rBase = (1 - y / h) * (h * 0.4);
                const angle = i * 0.3;
                const r = rBase * (0.8 + Math.random() * 0.4);
                
                const geo = geometries[Math.floor(Math.random() * geometries.length)];
                const mat = new THREE.MeshPhongMaterial({ 
                    color: colors[Math.floor(Math.random() * colors.length)],
                    shininess: 100,
                    emissive: new THREE.Color(0x222222)
                });

                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.set(Math.cos(angle) * r, y - 20, Math.sin(angle) * r);
                
                // å­˜å‚¨çˆ†ç‚¸ä½ç½®
                const explodeDir = mesh.position.clone().normalize().multiplyScalar(50 + Math.random() * 40);
                explodeDir.y += 20;

                mesh.userData = { origin: mesh.position.clone(), explode: explodeDir };
                treeGroup.add(mesh);
                decorMeshes.push(mesh);
            }

            // 2. çˆ±å¿ƒè£…é¥° (ç‰¹æ®Šå‡ ä½•ä½“)
            const heartShape = new THREE.Shape();
            heartShape.moveTo(0, 0); heartShape.bezierCurveTo(0, 0.5, 1, 1, 1, 0); // ç®€åŒ–çˆ±å¿ƒ
            const heartGeo = new THREE.ExtrudeGeometry(heartShape, { depth: 0.5, bevelEnabled: false });
            
            for(let i=0; i<30; i++) {
                const mat = new THREE.MeshPhongMaterial({ color: 0xff4444 });
                const mesh = new THREE.Mesh(heartGeo, mat);
                const y = Math.random() * h;
                const r = (1 - y/h) * (h * 0.4);
                const a = Math.random() * Math.PI * 2;
                mesh.position.set(Math.cos(a)*r, y-20, Math.sin(a)*r);
                mesh.scale.set(1.5, 1.5, 1.5);
                
                const explode = mesh.position.clone().normalize().multiplyScalar(80);
                mesh.userData = { origin: mesh.position.clone(), explode: explode };
                treeGroup.add(mesh);
                decorMeshes.push(mesh);
            }
        }

        // åˆ›å»ºç«‹ä½“æ˜Ÿæ˜Ÿ
        function create3DStar() {
            if(star) treeGroup.remove(star);
            const shape = new THREE.Shape();
            for (let i = 0; i < 10; i++) {
                const r = i % 2 === 0 ? 6 : 2.5;
                const a = (Math.PI * 2 * i) / 10;
                if (i === 0) shape.moveTo(Math.cos(a) * r, Math.sin(a) * r);
                else shape.lineTo(Math.cos(a) * r, Math.sin(a) * r);
            }
            const extrudeSettings = { depth: 2, bevelEnabled: true, bevelThickness: 1, bevelSize: 1 };
            const starGeo = new THREE.ExtrudeGeometry(shape, extrudeSettings);
            const starMat = new THREE.MeshPhongMaterial({ color: 0xffd700, shininess: 200, emissive: 0x443300 });
            star = new THREE.Mesh(starGeo, starMat);
            star.position.y = state.treeHeight - 15;
            treeGroup.add(star);
        }

        // ä¸Šä¼ ç…§ç‰‡å¹¶ç”Ÿæˆç…§ç‰‡äº‘
        document.getElementById('img-input').onchange = (e) => {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = new Image();
                    img.src = ev.target.result;
                    loadedImages.push(img);
                    createPhotoCloud(img);
                };
                reader.readAsDataURL(file);
            });
        };

        function createPhotoCloud(img) {
            const tex = new THREE.TextureLoader().load(img.src);
            const mat = new THREE.MeshBasicMaterial({ map: tex, side: THREE.DoubleSide });
            const mesh = new THREE.Mesh(new THREE.PlaneGeometry(8, 8), mat);
            
            const y = Math.random() * (state.treeHeight * 0.8);
            const r = (1 - y/state.treeHeight) * (state.treeHeight*0.4) + 10;
            const a = Math.random() * Math.PI * 2;
            
            mesh.position.set(Math.cos(a)*r, y-20, Math.sin(a)*r);
            const explode = mesh.position.clone().normalize().multiplyScalar(100);
            mesh.userData = { origin: mesh.position.clone(), explode: explode, isPhoto: true };
            
            treeGroup.add(mesh);
            decorMeshes.push(mesh);
        }

        function startTracking() {
            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5 });
            hands.onResults(results => {
                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    const lm = results.multiHandLandmarks[0];
                    const openDist = Math.hypot(lm[4].x - lm[20].x, lm[4].y - lm[20].y);
                    state.targetExplosion = Math.min(Math.max((openDist - 0.1) * 3, 0), 1);
                    
                    const pinchDist = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
                    const handY = 1.0 - lm[9].y;
                    const newH = 40 + (handY * 70);
                    
                    if(Math.abs(newH - state.treeHeight) > 5) {
                        state.treeHeight = newH;
                        create3DTree();
                        create3DStar();
                    }

                    if(pinchDist < 0.04) {
                        if(!state.photoActive && loadedImages.length > 0) {
                            const randImg = loadedImages[Math.floor(Math.random()*loadedImages.length)];
                            document.getElementById('modal-img').src = randImg.src;
                            document.getElementById('photo-modal').classList.add('active');
                            state.photoActive = true;
                        }
                    } else {
                        document.getElementById('photo-modal').classList.remove('active');
                        state.photoActive = false;
                    }
                    document.getElementById('status-bar').innerText = state.targetExplosion > 0.5 ? "ğŸ’¥ è®°å¿†çˆ†å‘ä¸­" : "ğŸ¤š é­”æ³•å‡èšä¸­";
                }
            });

            const cam = new Camera(document.getElementById('input_video'), {
                onFrame: async () => { await hands.send({image: document.getElementById('input_video')}); },
                width: 640, height: 480
            });
            cam.start();
        }

        function animate() {
            requestAnimationFrame(animate);
            state.explosion += (state.targetExplosion - state.explosion) * 0.1;
            
            decorMeshes.forEach(mesh => {
                const t = state.explosion;
                // ä½¿ç”¨ä¸‰æ¬¡ç¼“åŠ¨å‡½æ•°è®©çˆ†ç‚¸æ›´æœ‰å¼ åŠ›
                const ease = t * t * (3 - 2 * t);
                mesh.position.lerpVectors(mesh.userData.origin, mesh.userData.explode, ease);
                
                if(mesh.userData.isPhoto) {
                    mesh.lookAt(camera.position);
                } else {
                    mesh.rotation.y += 0.02;
                    mesh.rotation.x += 0.01;
                }
            });

            if(star) {
                star.rotation.z += 0.02;
                star.rotation.y += 0.01;
                const starS = 1 + Math.sin(Date.now() * 0.005) * 0.1;
                star.scale.set(starS, starS, starS);
            }

            treeGroup.rotation.y += 0.005 + state.explosion * 0.02;
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
