<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ‰‹åŠ¿äº¤äº’ç²’å­æ˜Ÿç©º - ä¿®å¤ç‰ˆ</title>
    
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <style>
        :root {
            --primary-glow: #00ffff;
            --panel-bg: rgba(15, 15, 25, 0.7);
        }

        body { 
            margin: 0; 
            overflow: hidden; 
            background: #000; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
        }

        /* 3D å®¹å™¨å±‚çº§è®¾ä¸ºåº• */
        #container { 
            position: absolute; 
            top: 0; left: 0;
            width: 100%; height: 100%; 
            z-index: 1; 
        }
        
        /* æ‘„åƒå¤´è§†å£ */
        #video-container {
            position: absolute; bottom: 20px; left: 20px;
            width: 180px; border-radius: 12px; overflow: hidden;
            border: 2px solid rgba(255,255,255,0.2); 
            transform: scaleX(-1);
            z-index: 10;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        #webcam { width: 100%; height: auto; display: block; }

        /* å³ä¾§æ§åˆ¶é¢æ¿ - æ ¸å¿ƒä¿®å¤ z-index */
        .panel {
            position: absolute; 
            right: 20px; 
            top: 50%; 
            transform: translateY(-50%);
            display: flex; 
            flex-direction: column; 
            gap: 12px;
            background: var(--panel-bg); 
            padding: 24px; 
            border-radius: 20px;
            backdrop-filter: blur(15px); 
            color: white;
            z-index: 100; /* ç¡®ä¿åœ¨æœ€é¡¶å±‚ */
            border: 1px solid rgba(255,255,255,0.1);
            width: 160px;
        }

        h3 { margin: 0 0 10px 0; font-size: 16px; text-align: center; opacity: 0.8; }

        button {
            padding: 12px; 
            border: none; 
            border-radius: 10px; 
            background: rgba(255,255,255,0.1);
            color: white; 
            cursor: pointer; 
            transition: all 0.3s ease;
            font-weight: 500;
        }

        button:hover { 
            background: rgba(255,255,255,0.25); 
            transform: translateX(-5px);
            box-shadow: 0 0 15px var(--primary-glow);
        }

        .control-group { display: flex; flex-direction: column; gap: 5px; margin-top: 10px; }
        label { font-size: 12px; opacity: 0.7; }
        
        input[type="range"] { cursor: pointer; accent-color: var(--primary-glow); }
        input[type="color"] { 
            border: none; width: 100%; height: 30px; 
            cursor: pointer; background: none; 
        }

        #fullscreen-btn { 
            position: absolute; bottom: 20px; right: 20px; 
            font-size: 24px; cursor: pointer; z-index: 100;
            color: white; opacity: 0.5; transition: 0.3s;
        }
        #fullscreen-btn:hover { opacity: 1; }
    </style>
</head>
<body>

<div id="container"></div>

<div id="video-container">
    <video id="webcam" autoplay playsinline></video>
</div>

<div class="panel">
    <h3>æ¨¡å‹é¢„è®¾</h3>
    <button onclick="changeModel('nebula')">ğŸŒŒ å¹»å½©æ˜Ÿäº‘</button>
    <button onclick="changeModel('fireworks')">ğŸ† ç››å¤§çƒŸèŠ±</button>
    <button onclick="changeModel('saturn')">ğŸª åœŸæ˜Ÿå…‰ç¯</button>
    <button onclick="changeModel('flower')">ğŸŒ¸ é‡å­èŠ±æœµ</button>
    
    <div class="control-group">
        <label>ç²’å­é¢œè‰²</label>
        <input type="color" id="colorPicker" value="#00ffff">
    </div>

    <div class="control-group">
        <label>ç²’å­å¯†åº¦</label>
        <input type="range" id="densitySlider" min="2000" max="30000" value="10000">
    </div>
</div>

<div id="fullscreen-btn" onclick="toggleFullScreen()">ğŸ”³</div>

<script>
/** --- Three.js åˆå§‹åŒ– --- **/
let scene, camera, renderer, particles, starField;
let currentPreset = 'nebula';
const clock = new THREE.Clock();

function initThree() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 5;

    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    document.getElementById('container').appendChild(renderer.domElement);

    createBackgroundStars();
    createParticleModel();
    animate();
}

// éšæœºèƒŒæ™¯æ˜Ÿç©º
function createBackgroundStars() {
    const geo = new THREE.BufferGeometry();
    const pos = [];
    for(let i=0; i<8000; i++) {
        pos.push((Math.random()-0.5)*150, (Math.random()-0.5)*150, (Math.random()-0.5)*150);
    }
    geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
    const mat = new THREE.PointsMaterial({ size: 0.03, color: 0xffffff, transparent: true, opacity: 0.4 });
    starField = new THREE.Points(geo, mat);
    scene.add(starField);
}

// åˆ›å»ºæ¨¡å‹
function createParticleModel() {
    if(particles) {
        scene.remove(particles);
        particles.geometry.dispose();
        particles.material.dispose();
    }

    const count = parseInt(document.getElementById('densitySlider').value);
    const geometry = new THREE.BufferGeometry();
    const positions = new Float32Array(count * 3);

    for(let i=0; i<count; i++) {
        let x, y, z;
        if(currentPreset === 'nebula') {
            x = (Math.random()-0.5)*6; y = (Math.random()-0.5)*6; z = (Math.random()-0.5)*6;
        } else if(currentPreset === 'saturn') {
            const r = 2.5 + Math.random()*1.5; 
            const theta = Math.random()*Math.PI*2;
            x = Math.cos(theta)*r; y = (Math.random()-0.5)*0.3; z = Math.sin(theta)*r;
        } else if(currentPreset === 'fireworks') {
            const r = Math.random()*4; const theta = Math.random()*Math.PI*2; const phi = Math.random()*Math.PI;
            x = r*Math.sin(phi)*Math.cos(theta); y = r*Math.sin(phi)*Math.sin(theta); z = r*Math.cos(phi);
        } else if(currentPreset === 'flower') {
            const t = Math.random()*Math.PI*2;
            const r = 2 * Math.sin(5 * t); // ç«ç‘°æ›²çº¿
            x = r * Math.cos(t); y = r * Math.sin(t); z = (Math.random()-0.5)*1;
        }
        positions.set([x, y, z], i * 3);
    }

    geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    
    const material = new THREE.PointsMaterial({
        size: 0.1,
        blending: THREE.AdditiveBlending,
        transparent: true,
        depthWrite: false,
        map: createCircleTexture(),
        color: new THREE.Color(document.getElementById('colorPicker').value)
    });

    particles = new THREE.Points(geometry, material);
    scene.add(particles);
}

function createCircleTexture() {
    const canvas = document.createElement('canvas');
    canvas.width = 64; canvas.height = 64;
    const ctx = canvas.getContext('2d');
    const grad = ctx.createRadialGradient(32,32,0, 32,32,32);
    grad.addColorStop(0, 'rgba(255,255,255,1)');
    grad.addColorStop(0.3, 'rgba(200,255,255,0.6)');
    grad.addColorStop(1, 'rgba(0,0,0,0)');
    ctx.fillStyle = grad;
    ctx.fillRect(0,0,64,64);
    return new THREE.CanvasTexture(canvas);
}

/** --- MediaPipe é€»è¾‘ --- **/
const videoElement = document.getElementById('webcam');
const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});

hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });

hands.onResults(results => {
    if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        const landmarks = results.multiHandLandmarks[0];
        
        // æ—‹è½¬
        const handX = (landmarks[9].x - 0.5) * 2;
        const handY = (landmarks[9].y - 0.5) * 2;
        particles.rotation.y += handX * 0.05;
        particles.rotation.x += handY * 0.05;

        // ç¼©æ”¾ (æåˆåŠ¨ä½œ)
        const dist = Math.hypot(landmarks[8].x - landmarks[4].x, landmarks[8].y - landmarks[4].y);
        const s = THREE.MathUtils.mapLinear(dist, 0.05, 0.4, 0.4, 3);
        particles.scale.lerp(new THREE.Vector3(s, s, s), 0.1);

        // é¢œè‰²åç§»
        const hue = (particles.rotation.y * 0.1) % 1;
        const baseColor = new THREE.Color(document.getElementById('colorPicker').value);
        let hsl = {}; baseColor.getHSL(hsl);
        baseColor.setHSL((hsl.h + hue) % 1, hsl.s, hsl.l);
        particles.material.color = baseColor;
    }
});

const cameraHandler = new Camera(videoElement, {
    onFrame: async () => { await hands.send({image: videoElement}); },
    width: 480, height: 360
});
cameraHandler.start();

/** --- äº¤äº’å‡½æ•° --- **/
window.changeModel = function(type) {
    currentPreset = type;
    createParticleModel();
};

function animate() {
    requestAnimationFrame(animate);
    if(particles) {
        particles.rotation.z += 0.001;
    }
    if(starField) starField.rotation.y += 0.0003;
    renderer.render(scene, camera);
}

function toggleFullScreen() {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen();
    else document.exitFullscreen();
}

window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});

document.getElementById('densitySlider').onchange = createParticleModel;
document.getElementById('colorPicker').oninput = (e) => {
    particles.material.color.set(e.target.value);
};

initThree();
</script>
</body>
</html>
