<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ‰‹åŠ¿äº¤äº’ç²’å­æ˜Ÿç©º</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        #container { position: absolute; width: 100%; height: 100%; }
        
        /* æ‘„åƒå¤´å°çª—å£ */
        #video-container {
            position: absolute; bottom: 20px; left: 20px;
            width: 180px; border-radius: 12px; overflow: hidden;
            border: 2px solid rgba(255,255,255,0.3); transform: scaleX(-1);
        }
        #webcam { width: 100%; height: auto; display: block; }

        /* å³ä¾§æ§åˆ¶é¢æ¿ */
        .panel {
            position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 10px;
            background: rgba(0,0,0,0.5); padding: 20px; border-radius: 15px;
            backdrop-filter: blur(10px); color: white;
        }
        button {
            padding: 10px; border: none; border-radius: 8px; background: rgba(255,255,255,0.2);
            color: white; cursor: pointer; transition: 0.3s;
        }
        button:hover { background: rgba(255,255,255,0.4); }
        input[type="range"] { width: 100%; }

        /* å…¨å±æŒ‰é’® */
        #fullscreen-btn { position: absolute; bottom: 20px; right: 20px; font-size: 24px; cursor: pointer; }
    </style>
</head>
<body>

<div id="container"></div>
<div id="video-container"><video id="webcam" autoplay playsinline></video></div>

<div class="panel">
    <h3 style="margin:0 0 10px 0">æ¨¡å‹é¢„è®¾</h3>
    <button onclick="changeModel('nebula')">å¹»å½©æ˜Ÿäº‘</button>
    <button onclick="changeModel('fireworks')">ç››å¤§çƒŸèŠ±</button>
    <button onclick="changeModel('saturn')">åœŸæ˜Ÿå…‰ç¯</button>
    <button onclick="changeModel('flower')">é‡å­èŠ±æœµ</button>
    <hr style="width:100%; border:0.5px solid rgba(255,255,255,0.2)">
    <label>ç²’å­é¢œè‰²</label>
    <input type="color" id="colorPicker" value="#00ffff">
    <label>ç²’å­å¯†åº¦</label>
    <input type="range" id="densitySlider" min="1000" max="20000" value="8000">
</div>

<div id="fullscreen-btn" onclick="toggleFullScreen()">ğŸ”²</div>

<script>
/** --- åˆå§‹åŒ– Three.js åœºæ™¯ --- **/
let scene, camera, renderer, particles, starField;
let currentPreset = 'nebula';
const clock = new THREE.Clock();

function initThree() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 5;

    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    document.getElementById('container').appendChild(renderer.domElement);

    // åˆ›å»ºèƒŒæ™¯æ·±ç©ºç²’å­
    createBackgroundStars();
    // åˆ›å»ºåˆå§‹ä¸»æ¨¡å‹
    createParticleModel();

    animate();
}

// éšæœºèƒŒæ™¯æ˜Ÿç©º
function createBackgroundStars() {
    const geo = new THREE.BufferGeometry();
    const pos = [];
    for(let i=0; i<5000; i++) {
        pos.push((Math.random()-0.5)*100, (Math.random()-0.5)*100, (Math.random()-0.5)*100);
    }
    geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
    const mat = new THREE.PointsMaterial({ size: 0.05, color: 0xffffff, transparent: true, opacity: 0.5 });
    starField = new THREE.Points(geo, mat);
    scene.add(starField);
}

/** --- æ ¸å¿ƒç²’å­é€»è¾‘ --- **/
function createParticleModel() {
    if(particles) scene.remove(particles);

    const count = document.getElementById('densitySlider').value;
    const geometry = new THREE.BufferGeometry();
    const positions = new Float32Array(count * 3);
    const colors = new Float32Array(count * 3);

    // æ ¹æ®é¢„è®¾ç”Ÿæˆå½¢çŠ¶
    for(let i=0; i<count; i++) {
        let x, y, z;
        if(currentPreset === 'nebula') {
            x = (Math.random()-0.5)*4; y = (Math.random()-0.5)*4; z = (Math.random()-0.5)*4;
        } else if(currentPreset === 'saturn') {
            const r = 2 + Math.random()*1; const theta = Math.random()*Math.PI*2;
            x = Math.cos(theta)*r; y = (Math.random()-0.5)*0.2; z = Math.sin(theta)*r;
        } else {
            // é»˜è®¤çƒä½“
            const u = Math.random(); const v = Math.random();
            const theta = 2 * Math.PI * u; const phi = Math.acos(2 * v - 1);
            x = 2 * Math.sin(phi) * Math.cos(theta);
            y = 2 * Math.sin(phi) * Math.sin(theta);
            z = 2 * Math.cos(phi);
        }
        positions.set([x, y, z], i * 3);
    }

    geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    
    // è‡ªå®šä¹‰ Shader å®ç°è¾‰å…‰å’Œè‰²ç›¸åç§»
    const material = new THREE.PointsMaterial({
        size: 0.08,
        vertexColors: true,
        blending: THREE.AdditiveBlending,
        transparent: true,
        map: createCircleTexture()
    });

    particles = new THREE.Points(geometry, material);
    scene.add(particles);
}

// ç”Ÿæˆåœ†ç‚¹å‘å…‰çº¹ç†
function createCircleTexture() {
    const canvas = document.createElement('canvas');
    canvas.width = 64; canvas.height = 64;
    const ctx = canvas.getContext('2d');
    const grad = ctx.createRadialGradient(32,32,0, 32,32,32);
    grad.addColorStop(0, 'rgba(255,255,255,1)');
    grad.addColorStop(0.2, 'rgba(255,255,255,0.8)');
    grad.addColorStop(1, 'rgba(0,0,0,0)');
    ctx.fillStyle = grad;
    ctx.fillRect(0,0,64,64);
    return new THREE.CanvasTexture(canvas);
}

/** --- MediaPipe æ‰‹åŠ¿å¤„ç† --- **/
const videoElement = document.getElementById('webcam');
const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});

hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });

hands.onResults(results => {
    if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        const landmarks = results.multiHandLandmarks[0];
        
        // 1. æ‰‹å¿ƒä½ç½®æ§åˆ¶æ—‹è½¬ (å–ä¸­æŒ‡æ ¹éƒ¨åæ ‡)
        const handX = landmarks[9].x - 0.5;
        const handY = landmarks[9].y - 0.5;
        particles.rotation.y += handX * 0.1;
        particles.rotation.x += handY * 0.1;

        // 2. æŠ“å–ç¨‹åº¦æ§åˆ¶ç¼©æ”¾ (é£ŸæŒ‡å°–ä¸å¤§æ‹‡æŒ‡å°–è·ç¦»)
        const dx = landmarks[8].x - landmarks[4].x;
        const dy = landmarks[8].y - landmarks[4].y;
        const distance = Math.sqrt(dx*dx + dy*dy);
        const scale = THREE.MathUtils.mapLinear(distance, 0.05, 0.3, 0.5, 2.5);
        particles.scale.set(scale, scale, scale);

        // 3. æ ¹æ®æ—‹è½¬è§’åº¦æ”¹å˜é¢œè‰²
        const hue = (particles.rotation.y % (Math.PI * 2)) / (Math.PI * 2);
        const baseColor = new THREE.Color(document.getElementById('colorPicker').value);
        baseColor.offsetHSL(hue, 0, 0);
        particles.material.color = baseColor;
    }
});

const cameraUtils = new Camera(videoElement, {
    onFrame: async () => { await hands.send({image: videoElement}); },
    width: 480, height: 360
});
cameraUtils.start();

/** --- è¾…åŠ©åŠŸèƒ½ --- **/
function animate() {
    requestAnimationFrame(animate);
    const time = clock.getElapsedTime();
    if(particles) {
        // åŸºç¡€æ¼‚æµ®åŠ¨ç”»
        particles.geometry.attributes.position.needsUpdate = true;
        starField.rotation.y += 0.0005;
    }
    renderer.render(scene, camera);
}

function changeModel(type) {
    currentPreset = type;
    createParticleModel();
}

function toggleFullScreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
    } else {
        document.exitFullscreen();
    }
}

window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});

document.getElementById('densitySlider').oninput = createParticleModel;

initThree();
</script>
</body>
</html>
